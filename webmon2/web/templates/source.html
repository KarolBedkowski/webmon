{% extends 'base.html' %}
{% import '_render_field.html' as rf %}
<!DOCTYPE html>
<html>
  <body>

{% block header %}
  <h1>{% block title %}Source{% endblock %}</h1>
<style>
	input,textarea,select {width: 75%;}
	label {width: 20%; display: inline-block; vertical-align: top;}
</style>
{% endblock %}

{% block content %}
	{% if errors %}
		<p class="error">
			<b>Validation errors:</b>
			{% for field, err in errors.items() %}
			<br/>{{ err }}
			{% endfor %}
		<p>
	{% endif %}
	<section>
		<form method="POST">
			<input type="hidden" name="_csrf_token" value="{{ session['_csrf_token'] }}"/>
			<p>
				<label for="source-kind">Kind</label>
				<input type="text" id="source-kind" readonly="readonly" value="{{ source_cls.short_info }}" />
			</p>
			<p><blockquote>{{ source_cls.long_info }}</blockquote></p>
			<p>
				<label for="source-name" class="field-required">Name</label>
				<input type="text" name="name" id="source-name" value="{{ form.name }}" required="required" />
			</p>
			{% if form.status != 0 %}
			<p>
				<label for="source-status">Status</label>
				<select name="status" id="source-status">
					{{ rf.render_option(1, "Active",  form.status) }}
					{{ rf.render_option(2, "Disabled",  form.status) }}
				</select>
			</p>
			{% endif %}
			<p>
				<label for="source-group">Group</label>
				<select name="group_id" id="source-group" value="{{ form.group_id }}">
					{% for group in groups %}
					<option value="{{ group.id }}" {% if group.id == form.group_id %} selected="selected"{% endif %}>{{ group.name }}</option>
					{% endfor %}
				</select>
			</p>
			<p>
				<label for="source-interval">Interval</label>
				<input type="text" name="interval" id="source-interval" value="{{ form.interval or '' }}"/>
			</p>
			{% if form.settings %}
			<p>
				<fieldset>
					<legend>Settings</legend>
					{% for sett in form.settings %}
						{{ rf.render_field(sett) }}
					{% endfor %}
				</fieldset>
			</p>
			{% endif %}
			<p class="row">
				{% if form.id %}
				<span class="left"><a href="{{ url_for('source.source_delete', source_id=form.id, delete_self=1) }}" data-req-confirm="yes" data-question="Realy delete source?">âš  Delete</a></span>
				{% endif %}
				<span class="right">
					{% if request.args.get('back') %}
						<a href="{{ request.args['back'] }}">Back</a>
					{% else %}
						<a href="#" data-action="hist-back">Back</a>
					{% endif %}
					<button type="submit">Save</button>
					<button type="submit" value="edit_filters" name="next_action">Save and edit filters</button>
				</span>
			</p>
		</form>
	</section>
	<section>
		<h2>State</h2>
		<p>Next update: {{ source.state.next_update | format_date }}</p>
		<p>Last update: {{ source.state.last_update | format_date }}</p>
		<p>Updates: {{ source.state.success_counter }}</p>
		<p>Errors: {{ source.state.error_counter }}</p>
		<p>Last error at: {{ source.state.last_error | format_date }}</p>
		<p>Last error message: {{ source.state.error }}</p>
		{% if source.state.state %}
		<h3>Additional</h3>
			{% for key, val in source.state.state.items() %}
				<p>{{ key }}: {{ val}}</p>
			{% endfor %}
		{% endif %}
	</section>
{% endblock %}

  </body>
</html>
